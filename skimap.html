<!DOCTYPE html>

<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0 }
  #button_large {height: 100; width: 100}
  #map_canvas { height: 100% }
</style>

<html>
<head>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.7.0-bundled-min.js"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<script type="text/javascript">
	StackMob.init({
		appName: "ski_map",
		clientSubdomain: "christophandersongmailcom",
		publicKey: "afd9bc44-1f38-4bb4-ae63-72b39d0abd21",
		apiVersion: 0
	});
	</script>





	<script>
	var watchID;
	var map;
	var currentPosition;
	var currentLat;
	var currentLong;
	var currentLatLong = new google.maps.LatLng(0,0);
	var currentPositionMarker;
	var currentPositionCircle;
	var user;
	var handleTimedEvent;
	var sessionID;
	var mapOptions;
	var followSwitch = true;
	var currentGeopoint;
	
	//Define classes for user query results
	var Result = StackMob.Model.extend({ schemaName: 'user' });
	var Results = StackMob.Collection.extend({ model: Result });
	var smQuery = new StackMob.Collection.Query();
	var results = new Results();
	var markers = new Array();
	
	//Initialize script at onload event
	function initialize()
	{
		//Adjust map html div to fill the page
		document.getElementById("map_canvas").style.height=("80%");
		
		//Create a random session identifier
		var temprandom = Math.floor(Math.random()*100000);
		sessionID = temprandom.toString();
		console.debug('sessionID: ' + sessionID);
		
		//Create a StackMob user with the sessionID
		user = new StackMob.User({ username: sessionID });
		user.create
		({
			success: function(model) 
				{console.debug("Created record with username: " + sessionID);},
			error: function(model, response) 
				{ console.debug("Unable to create user '" + sessionID + "'. Probably because it already exists?"); }
		});

		mapOptions = {
			center: new google.maps.LatLng(49,-123),
			zoom: 8,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		}
		
		map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
	}

	function StartTracking()
	 {
	  if (navigator.geolocation)
		{
		console.debug("Geolocation supported...");
		watchID = navigator.geolocation.watchPosition(showPosition,showError, {enableHighAccuracy:true, maximumAge:30000, timeout:27000});
		map.setZoom(18);
		}
	  else{console.debug("Geolocation is not supported by this browser.");}
	  
	  console.debug("Starting 10 second timed event...");
	  handleTimedEvent = self.setInterval(function(){clock()},10000);
	  clock();
	 }

	
	function clock()
	{
		var timecutoff = new Date();
		timecutoff = timecutoff - 3600000;
		console.debug("Submitting database query...");
		smQuery.gt('lastmoddate', timecutoff);
		results.query(smQuery, {success: ProcessResults, error: function(reporterror){console.debug("Error querying database!");}} );
		
	}	
	
	function ProcessResults()
	{
		console.debug("Processing results...");
		console.debug(results.toJSON());
		
		for(var i=0;i<results.length;i++)
		{
			place_marker(i, results.models[i]);
			if(results.models[i].get('username') == sessionID)
				{currentPositionMarker = markers[i];}
		}
	}
	
	
	function place_marker(i, individual)
	{
		var placed_LatLng = new google.maps.LatLng(individual.get('Lat'), individual.get('Long'));
		if(!markers[i]) 
			{markers[i] = new google.maps.Marker({position: placed_LatLng, map: map});}
		else
			{markers[i].setPosition(placed_LatLng);}
		
	}
	





	function showPosition(position)
	{
  	  
	currentPosition = position;
	currentLat = position.coords.latitude;
	currentLong = position.coords.longitude;
	user.set({ Lat:currentLat, Long: currentLong });
	if(geopoint)
		{geopoint.lat = currentLat; geopoint.lon = currentLong;}
	else
		{geopoint = new StackMob.GeoPoint(currentLat, currentLong);}
	  
	user.save();
	  
	  
	currentLatLong = new google.maps.LatLng(currentLat, currentLong);
	document.getElementById("Lat").textContent = "Lat:  " + currentLat;
	document.getElementById("Long").textContent = "Long: " + currentLong;
	  
	if (currentPositionMarker)
		{currentPositionMarker.setPosition(currentLatLong);}
	if (followSwitch)
		{map.setCenter(currentLatLong);}

	  
	}
	  
	  function stopWatching()
	  {
		navigator.geolocation.clearWatch(watchID);
		self.clearInterval(handleTimedEvent);
	  }

	function showError(error)
	  {
	  switch(error.code) 
		{
		case error.PERMISSION_DENIED:
		  console.debug("User denied the request for Geolocation.");
		  break;
		case error.POSITION_UNAVAILABLE:
		  console.debug("Location information is unavailable.");
		  break;
		case error.TIMEOUT:
		  console.debug("The request to get user location timed out.");
		  break;
		case error.UNKNOWN_ERROR:
		  console.debug("An unknown error occurred.");
		  break;
		}
	  }
	 
	 function toggleFollow()
	 {
		followSwitch = !followSwitch;
		if(followSwitch && currentLatLong)
			{map.setCenter(currentLatLong);}
	 }
	</script>
</head>





<body onload="initialize()">
<style>
button
{
	float:left;
	width:25%;
	height:50%;
	font-family:"Arial";
	text-align:center;
	font-size:14px;
}
p
{
	font-family:"Arial";
	text-align:center;
	line-height:0em;
	font-size:12pt;
	padding:0px;
}
</style>
<div style="height:20%; width:100%">
	<button onclick = "StartTracking()">Start<br>Tracking</button>
		<div style="float:left; height: 50%; width: 25%;"">
		<p id="User">User: </p>
	</div>
	<div style="float:left; height: 50%; width: 25%;"">
		<p id="Lat">Lat:  </p>
		<p id="Long">Long: </p>
	</div>

	<button onclick = "stopWatching()">Stop<br>Tracking</button>
	<button onclick = "toggleFollow()">Follow Me<br>On/Off</button>
	<button onclick = "zoomUsers()">Zoom:<br>Show Users</button>
	<button onclick = "toggleFollow()">-</button>
	<button onclick = "toggleFollow()">-</button>
  </div>
</div>

<div id="map_canvas" style="width: 100%"></div>

</body>
</html>




